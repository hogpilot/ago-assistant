require(["jquery","portal","mustache","nprogress","esri/arcgis/Portal","esri/arcgis/OAuthInfo","esri/IdentityManager","clipboard","jquery.ui","bootstrap-shim"],function(jquery,portalSelf,mustache,NProgress,arcgisPortal,arcgisOAuthInfo,esriId,Clipboard){var appInfo=new arcgisOAuthInfo({appId:"4E1s0Mv5r0c2l6W8",popup:!0,portalUrl:"https://www.arcgis.com"}),app={stats:{activities:{}},portals:{arcgisOnline:new portalSelf.Portal({portalUrl:"https://www.arcgis.com/"})}},getUrlParameter=function(sParam){var sParameterName,i,sURLVariables=decodeURIComponent(window.location.search.substring(1)).split("&");for(i=0;i<sURLVariables.length;i++)if((sParameterName=sURLVariables[i].split("="))[0].toLowerCase()===sParam.toLowerCase())return void 0===sParameterName[1]||sParameterName[1]},storedPortals=localStorage.getItem("storedPortals"),removePortal=function(portalUrl){var foundIndex;portalUrl=portalUrl.trim(),storedPortals.some(function(itm,n){if(itm.portalUrl==portalUrl)return foundIndex=n,!0}),foundIndex>=0&&storedPortals.splice(foundIndex,1),localStorage.setItem("storedPortals",JSON.stringify(storedPortals)),jquery("#portalList").children().each(function(n,itm){jquery(itm).first().text().trim()==portalUrl&&jquery(itm).remove()}),jquery("#portalList2").children().each(function(n,itm){jquery(itm).first().text().trim()==portalUrl&&jquery(itm).remove()}),jquery("#portalList").children().length||jquery("#portalListBtn").attr("disabled",!0),jquery("#portalList2").children().length||jquery("#portalList2Btn").attr("disabled",!0)},storePortal=function(portalItm){var portalUrl=portalItm.portalUrl,appId=portalItm.appId,usePkiIwa=portalItm.usePkiIwa,useOauth=portalItm.useOauth,useUserPass=portalItm.useUserPass,found=!1;storedPortals.some(function(itm,n){if(itm.portalUrl==portalUrl)return itm.appId=appId,found=!0,!0}),found||storedPortals.push({portalUrl:portalUrl,appId:appId,usePkiIwa:usePkiIwa,useOauth:useOauth,useUserPass:useUserPass}),localStorage.setItem("storedPortals",JSON.stringify(storedPortals)),jquery("#portalList").empty(),jquery("#portalList2").empty(),storedPortals.forEach(function(itm){jquery("#portalListBtn").removeAttr("disabled"),jquery("#portalList2Btn").removeAttr("disabled");var removeBtn=jquery('<a href="#" class="removePortalBtn btn-xs pull-right">   <span class="text-danger glyphicon glyphicon-remove" aria-hidden="true"></span></a>'),removeBtn2=jquery('<a href="#" class="removePortalBtn btn-xs pull-right">   <span class="text-danger glyphicon glyphicon-remove" aria-hidden="true"></span></a>'),portal=jquery('<a href="#">'+itm.portalUrl+"</a>"),portal2=jquery('<a href="#">'+itm.portalUrl+"</a>"),li=jquery("<li></li>"),li2=jquery("<li></li>");li.append(portal),li.append(removeBtn),li2.append(portal2),li2.append(removeBtn2),jquery("#portalList").append(li),jquery("#portalList2").append(li2),portal.on("click",function(){jquery("#portalAppId").val(itm.appId),jquery("#portalUrl").val(itm.portalUrl),app.portals.sourcePortal||(app.portals.sourcePortal=new portalSelf.Portal),validateUrl("#portalUrl",app.portals.sourcePortal,"#portalLoginBtn"),itm.appId?jquery("#oauthTabBtn").trigger("click"):(jquery("#userPassTabBtn").trigger("click"),jquery("#portalUsername").focus())}),portal2.on("click",function(){jquery("#portalAppId2").val(itm.appId),jquery("#destinationUrl").val(itm.portalUrl),app.portals.destinationPortal||(app.portals.destinationPortal=new portalSelf.Portal),validateUrl("#destinationUrl",app.portals.destinationPortal,"#destinationLoginBtn"),itm.appId?jquery("#oauthTab2Btn").trigger("click"):(jquery("#userPassTab2Btn").trigger("click"),jquery("#destinationUsername").focus())}),removeBtn.on("click",function(){removePortal(itm.portalUrl)}),removeBtn2.on("click",function(){removePortal(itm.portalUrl)})})};(storedPortals=storedPortals?JSON.parse(storedPortals):[]).forEach(function(itm){storePortal(itm)});var validateUrl=function(el,portal,loginBtnEl){"use strict";var inputUrl=jquery.trim(jquery(el).val());portalSelf.util.fixUrl(inputUrl).then(function(portalUrl){jquery(el).val(portalUrl);var urlError=jquery("#urlErrorTemplate").html(),checkbox=jquery(el).parent().parent().find("input[type='checkbox']");jquery(el).parent().removeClass("has-error"),jquery(el).next().removeClass("glyphicon-ok"),portal.portalUrl=portalUrl,portal.version().then(function(data){console.info("API v"+data.currentVersion),jquery(".alert-danger.alert-dismissable").remove(),jquery(el).next().addClass("glyphicon-ok"),jquery(loginBtnEl).removeAttr("disabled")}).catch(function(){portal.withCredentials=!0,portal.version().then(function(data){console.info("API v"+data.currentVersion),jquery(".alert-danger.alert-dismissable").remove(),jquery(el).next().addClass("glyphicon-ok"),jquery(loginBtnEl).removeAttr("disabled"),jquery(checkbox).trigger("click")}).catch(function(){portal.jsonp=!0,portal.version().then(function(data){portal.jsonp=!1,console.info("API v"+data.currentVersion),jquery(".alert-danger.alert-dismissable").remove(),jquery(el).next().addClass("glyphicon-ok"),jquery(loginBtnEl).removeAttr("disabled")}).catch(function(){portal.withCredentials=!1,portal.jsonp=!1,jquery(".alert-danger.alert-dismissable").remove(),jquery(el).parent().parent().after(urlError),jquery(el).parent().addClass("has-error"),jquery(loginBtnEl).attr("disabled",!0)})})})})},startSession=function(){"use strict";var searchHtml;app.portals.sourcePortal.self().then(function(data){var template=jquery("#sessionTemplate").html(),html=mustache.to_html(template,data);app.portals.sourcePortal.username=data.user.username,!0===data.isPortal?app.portals.sourcePortal.portalUrl="https://"+data.portalHostname+"/":!1===data.isPortal&&data.id?app.portals.sourcePortal.portalUrl="https://"+data.urlKey+"."+data.customBaseUrl+"/":app.portals.sourcePortal.portalUrl="https://www.arcgis.com/",jquery(".nav.navbar-nav").after(html),jquery("#logout").show(),jquery("#actionDropdown").css({visibility:"visible"}),searchHtml=mustache.to_html(jquery("#searchTemplate").html(),{portal:app.portals.sourcePortal.portalUrl,name:data.name,id:data.id}),jquery("#actionDropdown").before(searchHtml),jquery(document).on("click","i.glyphicon-search",function(){search()}),jquery("#searchForm").keypress(function(e){13==e.which&&search()}),NProgress.start(),listUserItems(),NProgress.done()})},loginPortal=function(){if(jquery("#oauthTab").hasClass("active"))loginPortalOAuth();else{jquery("#pkiIwaTab").hasClass("active")?app.portals.sourcePortal.withCredentials=!0:app.portals.sourcePortal.withCredentials=!1;var store=function(){var portalItm={portalUrl:app.portals.sourcePortal.portalUrl,appId:"",usePkiIwa:app.portals.sourcePortal.withCredentials,useOauth:!1,useUserPass:!app.portals.sourcePortal.withCredentials};storePortal(portalItm)},username=jquery("#portalUsername").val(),password=jquery("#portalPassword").val();jquery("#portalLoginBtn").button("loading"),app.portals.sourcePortal.generateToken(username,password).then(function(response){if(response.token)app.portals.sourcePortal.token=response.token,jquery("#portalLoginModal").modal("hide"),jquery("#splashContainer").css("display","none"),jquery("#itemsContainer").css("display","block"),startSession(),store();else if(400===response.error.code){var html=jquery("#loginErrorTemplate").html();jquery(".alert-danger.alert-dismissable").remove(),jquery("#portalLoginForm").before(html)}jquery("#portalLoginBtn").button("reset")}).catch(function(){jquery("#portalLoginBtn").button("reset");var html=jquery("#loginErrorTemplate").html();jquery(".alert-danger.alert-dismissable").remove(),jquery("#portalLoginForm").before(html)})}},loginPortalOAuth=function(){var portalInfo=new arcgisOAuthInfo({appId:jquery("#portalAppId").val(),popup:!0,portalUrl:app.portals.sourcePortal.portalUrl}),store=function(){var portalItm={portalUrl:portalInfo.portalUrl,appId:portalInfo.appId,usePkiIwa:!1,useOauth:!0,useUserPass:!1};storePortal(portalItm)};esriId.registerOAuthInfos([portalInfo]),portalSelf.util.fixUrl(portalInfo.portalUrl).then(function(portalUrl){var sharingUrl=portalUrl;-1===sharingUrl.indexOf("arcgis.com")&&(sharingUrl+="sharing/"),esriId.checkSignInStatus(sharingUrl).then(function(data){jquery("#portalLoginModal").modal("hide"),jquery("#splashContainer").css("display","none"),jquery("#itemsContainer").css("display","block"),app.portals.sourcePortal.username=data.userId,app.portals.sourcePortal.token=data.token,startSession(),store()}).otherwise(function(){esriId.getCredential(portalUrl,{oAuthPopupConfirmation:!1}).then(function(data){jquery("#portalLoginModal").modal("hide"),jquery("#splashContainer").css("display","none"),jquery("#itemsContainer").css("display","block"),app.portals.sourcePortal.username=data.userId,app.portals.sourcePortal.token=data.token,startSession(),store()})})})},loginDestination=function(){if(jquery("#oauthTab2").hasClass("active"))loginDestinationOAuth();else{var username=jquery("#destinationUsername").val(),password=jquery("#destinationPassword").val(),portalUrl=jquery("#destinationUrl").val();app.portals.destinationPortal||(app.portals.destinationPortal=new portalSelf.Portal({portalUrl:portalUrl})),jquery("#pkiIwaTab2").hasClass("active")?app.portals.destinationPortal.withCredentials=!0:app.portals.destinationPortal.withCredentials=!1;var store=function(){var portalItm={portalUrl:app.portals.destinationPortal.portalUrl,appId:"",usePkiIwa:app.portals.destinationPortal.withCredentials,useOauth:!1,useUserPass:!app.portals.destinationPortal.withCredentials};storePortal(portalItm)};jquery("#destinationLoginBtn").button("loading"),jquery("#dropArea").empty(),app.portals.destinationPortal.generateToken(username,password).then(function(response){if(response.token)app.portals.destinationPortal.token=response.token,app.portals.destinationPortal.self().then(function(data){app.portals.destinationPortal.username=data.user.username,!0===data.isPortal?app.portals.destinationPortal.portalUrl="https://"+data.portalHostname+"/":!1===data.isPortal&&data.id?app.portals.destinationPortal.portalUrl="https://"+data.urlKey+"."+data.customBaseUrl+"/":app.portals.destinationPortal.portalUrl="https://"+data.portalHostname+"/",jquery("#copyModal").modal("hide"),highlightCopyableContent(),NProgress.start(),showDestinationFolders(),NProgress.done(),store()});else if(400===response.error.code){var html=jquery("#loginErrorTemplate").html();jquery(".alert-danger.alert-dismissable").remove(),jquery("#destinationLoginForm").before(html)}}).catch(function(){var html=jquery("#loginErrorTemplate").html();jquery(".alert-danger.alert-dismissable").remove(),jquery("#destinationLoginForm").before(html)}).then(function(){jquery("#destinationLoginBtn").button("reset")})}},loginDestinationOAuth=function(){var portalInfo=new arcgisOAuthInfo({appId:jquery("#portalAppId2").val(),popup:!0,portalUrl:app.portals.destinationPortal.portalUrl});esriId.registerOAuthInfos([portalInfo]);var store=function(){var portalItm={portalUrl:portalInfo.portalUrl,appId:portalInfo.appId,usePkiIwa:!1,useOauth:!0,useUserPass:!1};storePortal(portalItm)},appIdJson=esriId.toJson(),esriJSAPIOAuth=sessionStorage.esriJSAPIOAuth;sessionStorage.setItem("esriJSAPIOAuthBackup",esriJSAPIOAuth),sessionStorage.setItem("esriIdBackup",JSON.stringify(appIdJson)),esriId.destroyCredentials(),sessionStorage.removeItem("esriJSAPIOAuth"),portalSelf.util.fixUrl(portalInfo.portalUrl).then(function(portalUrl){var sharingUrl=portalUrl;-1===sharingUrl.indexOf("arcgis.com")&&(sharingUrl+="sharing/"),esriId.checkSignInStatus(sharingUrl).then(function(data){app.portals.destinationPortal&&app.portals.destinationPortal.portalUrl===portalInfo.portalUrl?(app.portals.destinationPortal.username=data.userId,app.portals.destinationPortal.token=data.token):app.portals.destinationPortal=new portalSelf.Portal({portalUrl:portalInfo.portalUrl,username:data.userId,token:data.token}),esriId.initialize(appIdJson),sessionStorage.setItem("esriJSAPIOAuth",esriJSAPIOAuth),app.portals.destinationPortal.self().then(function(){jquery("#copyModal").modal("hide"),highlightCopyableContent(),NProgress.start(),showDestinationFolders(),NProgress.done(),store()})}).otherwise(function(){esriId.getCredential(portalUrl,{oAuthPopupConfirmation:!1}).then(function(data){app.portals.destinationPortal&&app.portals.destinationPortal.portalUrl===portalInfo.portalUrl?(app.portals.destinationPortal.username=data.userId,app.portals.destinationPortal.token=data.token):app.portals.destinationPortal=new portalSelf.Portal({portalUrl:portalInfo.portalUrl,username:data.userId,token:data.token}),esriId.initialize(appIdJson),sessionStorage.setItem("esriJSAPIOAuth",esriJSAPIOAuth),app.portals.destinationPortal.self().then(function(){jquery("#copyModal").modal("hide"),highlightCopyableContent(),NProgress.start(),showDestinationFolders(),NProgress.done(),store()})})})})},logout=function(){sessionStorage.clear(),app.stats.activities={},jquery("#actionDropdown li").removeClass("active"),jquery("#itemsArea").empty(),jquery("#dropArea").empty(),jquery("#sessionDropdown").remove(),jquery("#searchForm").remove(),jquery("#actionDropdown").css({visibility:"hidden"}),esriId.destroyCredentials(),delete app.portals.sourcePortal,delete app.portals.destinationPortal,window.location.reload()},search=function(){var portal,query=jquery("#searchText").val(),portalUrl=jquery("#searchMenu li.active").attr("data-url");jquery("#searchMenu li.active").attr("data-id")&&(query+=" accountid:"+jquery("#searchMenu li.active").attr("data-id")),"Search My Content"===jquery("#searchMenu li.active").text()&&(query+=" owner:"+app.portals.sourcePortal.username),portal="https://www.arcgis.com/"===portalUrl&&portalUrl!==app.portals.sourcePortal.portalUrl?app.portals.arcgisOnline:app.portals.sourcePortal,NProgress.start(),portal.search(query,100,"numViews","desc").then(function(results){listSearchItems(portal.portalUrl,results),NProgress.done()})},inspectContent=function(){var portal,jsonValid,descEditor,dataEditor,jsonBackup={};new Clipboard(".btn",{text:function(trigger){var targetId=jquery(trigger).attr("data-clipboard-target");return"#descriptionJson"==targetId?descEditor.getValue():"#dataJson"==targetId?dataEditor.getValue():""}}).on("success",function(e){var el=jquery(e.trigger);setTimeout(function(){el.attr("title","Copied!").tooltip("fixTitle").tooltip("show"),setTimeout(function(){el.attr("title","Copy JSON").tooltip("fixTitle").tooltip("hide")},1e3)},300),e.clearSelection()});var validateJson=function(elId){var messages=("descriptionJson"==elId?descEditor:dataEditor).session.getAnnotations();return!messages.length||messages[0].text+" [line "+(messages[0].row+1)+", col "+messages[0].column+"]"},startEditing=function(e){e.stopImmediatePropagation();var codeBlock=jquery(e.currentTarget).parent().next(),editButton=jquery(e.currentTarget),saveButton=jquery(e.currentTarget).parent().children("[data-action='saveEdits']"),editor="descriptionJson"==codeBlock[0].id?descEditor:dataEditor;saveButton.css("color","").children("span").attr("class","fa fa-lg fa-save"),editor.getReadOnly()?(saveButton.attr("title","No changes").tooltip("fixTitle"),editButton.children("span").attr("class","fa fa-lg fa-undo"),editButton.tooltip("hide").attr("title","Discard your edits").tooltip("fixTitle"),jsonBackup[codeBlock[0].id]=editor.getValue(),editor.setReadOnly(!1),editor.setTheme("ace/theme/tomorrow_night"),editor.getSession().on("changeAnnotation",function(){editor.getReadOnly()||(jsonValid=validateJson(codeBlock[0].id),saveButton.attr("title","").tooltip("fixTitle"),!0===jsonValid?(saveButton.removeClass("disabled"),saveButton.css("color","green"),saveButton.attr("title","JSON is valid. Click to save.").tooltip("fixTitle")):(saveButton.css("color","red"),saveButton.attr("title",jsonValid).tooltip("fixTitle")))}),editButton.attr("class","btn btn-default"),saveButton.attr("class","btn btn-default")):(editor.setValue(jsonBackup[codeBlock[0].id],-1),editor.setReadOnly(!0),editor.setTheme("ace/theme/tomorrow"),editButton.attr("class","btn btn-default"),editButton.children("span").attr("class","fa fa-lg fa-pencil"),editButton.tooltip("hide").attr("title","Edit JSON").tooltip("fixTitle"),saveButton.attr("class","btn btn-default disabled"),saveButton.css("color","black")),saveButton.off("click"),saveButton.click(function(){if(!0===jsonValid){var newJson=editor.getValue(),itemInfo=JSON.parse(descEditor.getValue());editButton.attr("class","btn btn-default"),editButton.children("span").attr("class","fa fa-lg fa-pencil"),saveButton.attr("class","btn btn-default disabled"),saveButton.css("color","black"),editor.setReadOnly(!0),editor.setTheme("ace/theme/tomorrow"),editButton.attr("title","Edit JSON").tooltip("fixTitle"),saveButton.children("span").attr("class","fa fa-lg fa-spinner fa-spin");var ownerFolder;ownerFolder=itemInfo.ownerFolder?itemInfo.ownerFolder:"/","Description"===editButton.attr("data-container")?portal.updateDescription(itemInfo.owner,itemInfo.id,ownerFolder,newJson).then(function(response){response.success?(saveButton.children("span").attr("class","fa fa-lg fa-check"),saveButton.css("color","green")):(saveButton.children("span").attr("class","fa fa-lg fa-times"),saveButton.css("color","red"))}):"Data"===editButton.attr("data-container")&&(saveButton.children("span").attr("class","fa fa-lg fa-spinner fa-spin"),portal.updateData(itemInfo.owner,itemInfo.id,ownerFolder,newJson).then(function(response){response.success?(saveButton.children("span").attr("class","fa fa-lg fa-check"),saveButton.css("color","green")):(saveButton.children("span").attr("class","fa fa-lg fa-times"),saveButton.css("color","red"))}))}else saveButton.blur()})};jquery(".content").addClass("data-toggle"),jquery(".content").removeAttr("disabled"),jquery(".content").attr("data-toggle","button"),jquery(".content").addClass("btn-info"),jquery("#inspectModal").modal("hide"),jquery("#inspectBtn").button("reset"),jquery(".content").click(function(){var server=jquery(this).attr("data-portal"),id=jquery(this).attr("data-id"),title=jquery(this).text();title=title.substring(0,title.search("Type:")).trim();var itemData;portal="https://www.arcgis.com/"===server&&server!==app.portals.sourcePortal.portalUrl?app.portals.arcgisOnline:app.portals.sourcePortal,NProgress.start(),jquery(".content").addClass("btn-info"),jquery(".content").removeClass("active"),jquery(".content").removeClass("btn-primary"),jquery(this).addClass("btn-primary"),jquery(this).removeClass("btn-info");var checkData=function(id,name){return new Promise(function(resolve,reject){resolve(!name||name&&name.indexOf(".")<0?portal.itemData(id):null)})};portal.itemDescription(id).then(function(description){checkData(id,description.name).then(function(data){data&&(itemData=data);var templateData={title:title,url:portal.portalUrl,id:id,description:JSON.stringify(description,void 0,4),data:JSON.stringify(itemData,void 0,4)};void 0===templateData.data&&-1===description.typeKeywords.indexOf("Service")&&(templateData.downloadLink=portal.portalUrl+"sharing/rest/content/items/"+id+"/data?token="+portal.token);var html=mustache.to_html(jquery("#inspectTemplate").html(),templateData);jquery("#dropArea").html(html),jquery("#dropArea").find("button").attr("data-toggle","tooltip").attr("data-placement","bottom").tooltip({container:"body",placement:"bottom"}),jquery(".jsonViewer").each(function(i,e){var editor=window.ace.edit(e.id);"descriptionJson"==e.id?descEditor=editor:"dataJson"==e.id&&(dataEditor=editor),editor.getSession().setUseWrapMode(!0),editor.setOptions({maxLines:1/0,mode:"ace/mode/json",readOnly:!0,showPrintMargin:!1,tabSize:4,theme:"ace/theme/tomorrow"}),editor.$blockScrolling=1/0,editor.setReadOnly(!0)}),jquery(".btn-default[data-action='startEdits']").click(function(e){if(localStorage.hasOwnProperty("editsAllowed"))startEditing(e);else{var editJsonBtn=jquery("#editJsonBtn");jquery("#editJsonModal").modal("show"),jquery(".acknowledgeRisk").click(function(e){jquery(e.currentTarget).prop("checked")?editJsonBtn.removeClass("disabled"):editJsonBtn.addClass("disabled")})}jquery("#editJsonBtn").click(function(){jquery("#editJsonModal").modal("hide"),localStorage.setItem("editsAllowed",!0),startEditing(e)})}),NProgress.done()})})})},updateWebmapServices=function(){var webmapData,owner,folder,supportedContent=jquery.merge(jquery(".content[data-type='Web Map']"),jquery(".content[data-type='Web Scene']")),portal=app.portals.sourcePortal;supportedContent.addClass("data-toggle btn-info"),supportedContent.removeAttr("disabled"),supportedContent.attr("data-toggle","button"),jquery(".content").click(function(){var id=jquery(this).attr("data-id"),webmapTitle=jquery(this).text();jquery(".content[data-type='Web Map']").addClass("btn-info"),jquery(".content").removeClass("active"),jquery(".content").removeClass("btn-primary"),jquery(this).addClass("btn-primary"),jquery(this).removeClass("btn-info"),portal.itemDescription(id).then(function(description){owner=description.owner,folder=description.ownerFolder?description.ownerFolder:""}),portal.itemData(id).then(function(data){function getHostFromURL(href){var parsedUrl=href.match(/^(https?\:)\/\/(([^:\/?#]*)(?:\:([0-9]+))?)(\/[^?#]*)(\?[^#]*|)(#.*|)$/);return parsedUrl[1]+"//"+parsedUrl[2]}webmapData=JSON.stringify(data);var operationalLayers=[];jquery.each(data.operationalLayers,function(){this.hasOwnProperty("url")?operationalLayers.push(this):this.hasOwnProperty("styleUrl")&&(this.url=this.styleUrl,operationalLayers.push(this))});var tables=[];data.tables&&jquery.each(data.tables,function(table){data.tables[table].hasOwnProperty("url")&&tables.push(data.tables[table])});var basemapTitle=data.baseMap.title,basemapLayers=[];jquery.each(data.baseMap.baseMapLayers,function(){this.hasOwnProperty("url")?basemapLayers.push(this):this.hasOwnProperty("styleUrl")&&(this.url=this.styleUrl,basemapLayers.push(this))});var template=jquery("#webmapServicesTemplate").html(),templateData={webmapTitle:webmapTitle,operationalLayers:operationalLayers,tables:tables,basemapTitle:basemapTitle,basemapLayers:basemapLayers},html=mustache.to_html(template,templateData);jquery("#dropArea").html(html);var webmapServices=jquery("[data-original]"),currentUniqueRootUrlVals=[];jquery("#origServiceUrlList").empty(),jquery.each(webmapServices,function(service){var rootOfCurrentUrl=getHostFromURL(jquery(webmapServices[service]).val());-1===jquery.inArray(rootOfCurrentUrl,currentUniqueRootUrlVals)&&(currentUniqueRootUrlVals.push(rootOfCurrentUrl),jquery("#origServiceUrlList").append("<option value="+rootOfCurrentUrl+">"+rootOfCurrentUrl+"</option>"))}),jquery("#originalTextUserInput").bind("input",function(){var origTextUserInput=jquery("#originalTextUserInput").val(),numFoundStringMatches=0;if(origTextUserInput.length>0){var webmapServices=jquery("[data-original]");jquery.each(webmapServices,function(service){jquery(webmapServices[service]).val().indexOf(origTextUserInput)>-1&&(numFoundStringMatches+=1)})}var matchText=1===numFoundStringMatches?"match":"matches";jquery("#stringMatchesFoundText").text("Found "+numFoundStringMatches.toString()+" text "+matchText+" in this web map's service URLs (case sensitive).")}),jquery("#bulkUpdateWebmapServiceUrlsBtn").click(function(e){e.preventDefault();var origTextUserInput=jquery("#originalTextUserInput").val(),newTextUserInput=jquery("#newTextUserInput").val();if(origTextUserInput.length>0){var webmapServices=jquery("[data-original]"),foundMatches=0;jquery.each(webmapServices,function(service){var originalUrl=jquery(webmapServices[service]).val();if(originalUrl.indexOf(origTextUserInput)>-1){var newCalculatedUrl=originalUrl.replace(origTextUserInput,newTextUserInput);jquery(webmapServices[service]).val(newCalculatedUrl),foundMatches+=1}})}jquery("#originalTextUserInput").val(""),jquery("#newTextUserInput").val(""),jquery("#stringMatchesFoundText").text("")}),jquery("#btnUpdateWebmapServices").click(function(){var webmapServices=jquery("[data-original]");jquery.each(webmapServices,function(service){var originalUrl=jquery(webmapServices[service]).attr("data-original"),newUrl=jquery(webmapServices[service]).val();webmapData=webmapData.replace('"'+originalUrl+'"','"'+newUrl+'"'),jquery(webmapServices[service]).val(newUrl)});var webmapId=jquery(".content.active.btn-primary").attr("data-id"),itemData=JSON.parse(webmapData);portal.updateWebmapData(owner,folder,webmapId,itemData).then(function(response){var html;response.success?(jquery.each(webmapServices,function(service){jquery(webmapServices[service]).attr("data-original",jquery(webmapServices[service]).val())}),html=mustache.to_html(jquery("#updateSuccessTemplate").html()),jquery("#btnResetWebmapServices").before(html)):400!==response.error.code&&403!==response.error.code||(jquery("#btnResetWebmapServices").click(),html=mustache.to_html(jquery("#updateErrorTemplate").html(),response),jquery("#btnResetWebmapServices").before(html))})}),jquery("#btnResetWebmapServices").click(function(){var webmapServices=jquery("[data-original]");jquery.each(webmapServices,function(service){var originalUrl=jquery(webmapServices[service]).attr("data-original");jquery(webmapServices[service]).val(originalUrl)})})})})},updateContentUrls=function(){var owner,folder,supportedContent=jquery(".content[data-type='Feature Service'], .content[data-type='Map Service'], .content[data-type='Image Service'], .content[data-type='KML'], .content[data-type='WMS'], .content[data-type='Geodata Service'], .content[data-type='Globe Service'], .content[data-type='Geometry Service'], .content[data-type='Geocoding Service'], .content[data-type='Network Analysis Service'], .content[data-type='Geoprocessing Service'], .content[data-type='Web Mapping Application'], .content[data-type='Mobile Application'], .content[data-type='Scene Service'], .content[data-type='Vector Tile Service']"),portal=app.portals.sourcePortal;supportedContent.addClass("data-toggle btn-info"),supportedContent.removeAttr("disabled"),supportedContent.attr("data-toggle","button"),jquery(".content").click(function(){var id=jquery(this).attr("data-id");supportedContent.addClass("btn-info"),jquery(".content").removeClass("active"),jquery(".content").removeClass("btn-primary"),jquery(this).addClass("btn-primary"),jquery(this).removeClass("btn-info"),portal.itemDescription(id).then(function(description){owner=description.owner,folder=description.ownerFolder?description.ownerFolder:"";var html=mustache.to_html(jquery("#itemContentTemplate").html(),description);jquery("#dropArea").html(html),jquery("#btnUpdateContentUrl").click(function(){var contentId=jquery(".content.active.btn-primary").attr("data-id"),url=jquery("[data-original]").val();portal.updateUrl(owner,folder,contentId,url).then(function(response){var html;response.success?(jquery("[data-original]").attr("data-original",url),html=mustache.to_html(jquery("#updateSuccessTemplate").html()),jquery("#btnResetContentUrl").before(html)):400!==response.error.code&&403!==response.error.code||(jquery("#btnResetContentUrl").click(),html=mustache.to_html(jquery("#updateErrorTemplate").html(),response),jquery("#btnResetContentUrl").before(html))})}),jquery("#btnResetContentUrl").click(function(){var originalUrl=jquery("[data-original]").attr("data-original");jquery("[data-original]").val(originalUrl)})})})},viewStats=function(){var portal=app.portals.sourcePortal;portal.userProfile(portal.username).then(function(user){var thumbnailUrl,template=jquery("#statsTemplate").html();thumbnailUrl=user.thumbnail?portal.portalUrl+"sharing/rest/community/users/"+user.username+"/info/"+user.thumbnail+"?token="+portal.token:"assets/images/no-user-thumb.jpg";var templateData={username:user.username,thumbnail:thumbnailUrl},html=mustache.to_html(template,templateData);jquery("body").append(html),jquery("#statsModal").modal("show");var searchQuery="owner:"+portal.username;portal.search(searchQuery,3,"numViews","desc").then(function(results){jquery.each(results.results,function(result){results.results[result].numViews=results.results[result].numViews.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),results.results[result].itemUrl=portal.portalUrl+"home/item.html?id="+results.results[result].id});var tableTemplate=jquery("#mostViewedContentTemplate").html();jquery("#mostViewedContent").html(mustache.to_html(tableTemplate,{searchResults:results.results}))}),jquery("#statsModal").on("hidden.bs.modal",function(){jquery("#statsModal").remove()})})},checkServiceName=function(destinationPortal){var deferred=new jquery.Deferred,nameInput=jquery("#serviceName");return jquery("#serviceName").off("blur"),nameInput.blur(function(){var name=nameInput.val();destinationPortal.self().then(function(self){destinationPortal.checkServiceName(self.user.orgId,name,"Feature Service").then(function(available){if(!0!==available.available){var nameError=mustache.to_html(jquery("#serviceNameErrorTemplate").html(),{name:name});jquery(".alert-danger.alert-dismissable").remove(),nameInput.parent().parent().after(nameError),nameInput.parent().addClass("has-error"),nameInput.next().removeClass("glyphicon-ok")}else name=nameInput.val(),jquery(".alert-danger.alert-dismissable").remove(),nameInput.parent().removeClass("has-error"),nameInput.next().addClass("glyphicon-ok"),jquery("#btnCopyService").removeClass("disabled"),deferred.resolve(name)})})}),deferred.promise()},showCopyError=function(id,message){var html=mustache.to_html(jquery("#contentCopyErrorTemplate").html(),{id:id,message:message});jquery("#"+id+"_clone").before(html)},simpleCopy=function(id,folder){var portal,portalUrl=jquery("#"+id).attr("data-portal");portal="https://www.arcgis.com/"===portalUrl&&portalUrl!==app.portals.sourcePortal.portalUrl?app.portals.arcgisOnline:app.portals.sourcePortal;var destinationPortal=app.portals.destinationPortal,description=jquery.grep(portal.items,function(item){return item.id===id})[0].description,thumbnailUrl=portal.portalUrl+"sharing/rest/content/items/"+id+"/info/"+description.thumbnail+"?token="+portal.token,cloneDiv=jquery("#"+id+"_clone");cloneDiv.addClass("btn-info"),cloneDiv.find(".copyInProgress").css("display","inline-block"),cloneDiv.find(".itemId a").css("display","none"),portal.itemData(id).then(function(data){var thenFunction=function(response){var html,oldLink,newLink;if(!0===response.success)if(description.url.indexOf("id=")>-1){var newUrl=destinationPortal.portalUrl+description.url.substring(description.url.indexOf("apps/"));newUrl=newUrl.replace("id="+description.id,"id="+response.id);var folder2=response.folder||"";destinationPortal.updateUrl(destinationPortal.username,folder2,response.id,newUrl).then(function(){cloneDiv.removeClass("btn-info"),cloneDiv.addClass("btn-success"),oldLink=cloneDiv.find(".itemId a").attr("href"),newLink=oldLink.replace(description.id,response.id),cloneDiv.find(".copyInProgress").css("display","none"),cloneDiv.find(".itemId a").css("display","inline-block"),cloneDiv.find(".itemId a").attr("href",newLink),cloneDiv.find(".itemId a").html('<abbr title="'+response.id+'">'+response.id.substring(0,6)+"</abbr>")})}else cloneDiv.removeClass("btn-info"),cloneDiv.addClass("btn-success"),oldLink=cloneDiv.find(".itemId a").attr("href"),newLink=oldLink.replace(description.id,response.id),cloneDiv.find(".copyInProgress").css("display","none"),cloneDiv.find(".itemId a").css("display","inline-block"),cloneDiv.find(".itemId a").attr("href",newLink),cloneDiv.find(".itemId a").html('<abbr title="'+response.id+'">'+response.id.substring(0,6)+"</abbr>");else response.error&&(response.error.message.search(" already exists.")>=0?(description=Object.assign({},description,{title:description.title+"-Copy"}),cloneDiv.find(".itemTitle").text(description.title),destinationPortal.addItem(destinationPortal.username,folder,description,data,thumbnailUrl).then(thenFunction).catch(catchFunction)):(cloneDiv.addClass("btn-danger"),html=mustache.to_html(jquery("#contentCopyErrorTemplate").html(),{id:id,message:response.error.message}),cloneDiv.before(html),cloneDiv.fadeOut(2e3,function(){jquery(this).remove()}),jquery("#"+id+"_alert").fadeOut(3e3,function(){jquery(this).remove()})))},catchFunction=function(){jquery("#"+id+"_alert")||showCopyError(id,"Something went wrong."),cloneDiv.fadeOut(2e3,function(){jquery(this).remove()}),jquery("#"+id+"_alert").fadeOut(3e3,function(){jquery(this).remove()})};destinationPortal.addItem(destinationPortal.username,folder,description,data,thumbnailUrl).then(thenFunction).catch(catchFunction)})},deepCopyFeatureService=function(id,folder){var portal,portalUrl=jquery("#"+id).attr("data-portal");portal="https://www.arcgis.com/"===portalUrl&&portalUrl!==app.portals.sourcePortal.portalUrl?app.portals.arcgisOnline:app.portals.sourcePortal;var destinationPortal=app.portals.destinationPortal,name=jquery("#serviceName").val(),item=jquery.grep(portal.items,function(item){return item.id===id}),description=item[0].description,serviceDescription=item[0].serviceDescription,layers=serviceDescription.layers,clone=jquery("#"+id+"_clone"),span=jquery("#"+id+"_clone > span");clone.text(name),clone.prepend(span),clone.addClass("btn-info"),clone.append("<div class='message'><p class='messages'></p></div>");var messages=jquery("#"+id+"_clone").find(".messages");serviceDescription.name=name;var serviceDefinition=serviceDescription;delete serviceDefinition.layers,messages.text("creating service"),messages.after("<img src='css/grid.svg' class='harvester'/>"),destinationPortal.createService(destinationPortal.username,folder,JSON.stringify(serviceDefinition)).then(function(service){clone.attr("data-id",service.itemId),clone.attr("data-portal",destinationPortal.portalUrl),service.serviceurl=portalSelf.util.upgradeUrl(service.serviceurl);var newTags=description.tags;newTags.push("sourceId-"+description.id),newTags.push("copied with ago-assistant"),destinationPortal.updateDescription(destinationPortal.username,service.itemId,folder,JSON.stringify({tags:newTags})),portal.serviceLayers(description.url).then(function(definition){var layerCount=definition.layers.length,layerJobs={},layerSummary={},reportResult=function(layerId){if(layerJobs[layerId].attempted>=layerJobs[layerId].recordCount&&(layerSummary[layerId]=layerJobs[layerId],delete layerJobs[layerId]),0===Object.keys(layerJobs).length){var errors=!1;console.info("Copy summary for "+name),Object.keys(layerSummary).forEach(function(k){var layer=layerSummary[k];layer.added!==layer.recordCount?(errors=!0,console.warn(k+" ("+layer.name+"): Added "+layer.added.toLocaleString([])+"/"+layer.recordCount.toLocaleString([])+" records")):console.info(k+" ("+layer.name+"): Added "+layer.added.toLocaleString([])+"/"+layer.recordCount.toLocaleString([])+" records")}),clone.find("img").remove(),clone.removeClass("btn-info"),errors?(clone.addClass("btn-warning"),messages.text("Incomplete--check console")):(clone.addClass("btn-success"),messages.text("Copy OK"))}};jquery.each(definition.layers,function(i,layer){layerJobs[layer.id]={name:layer.name,recordCount:0,attempted:0,added:0},layer.adminLayerInfo={geometryField:{name:"Shape",srid:102100}},layer.indexes=[]}),messages.text("updating definition"),destinationPortal.addToServiceDefinition(service.serviceurl,JSON.stringify(definition)).then(function(response){"error"in response?(clone.find("img").remove(),clone.removeClass("btn-info"),clone.addClass("btn-danger"),messages.text("Failed—check console"),console.info("Copy summary for "+name),console.warn(response.error.message),response.error.details.forEach(function(detail){console.warn(detail)})):jquery.each(layers,function(i,v){var layerId=v.id;portal.layerRecordCount(description.url,layerId).then(function(records){var offset=0;layerJobs[layerId].recordCount=records.count;for(var count=definition.layers[layerId].maxRecordCount<1?1e3:definition.layers[layerId].maxRecordCount;offset<=records.count;)0,messages.text("harvesting data"),portal.harvestRecords(description.url,layerId,offset,count).then(function(serviceData){messages.text("adding features for "+layerCount+" layers"),destinationPortal.addFeatures(service.serviceurl,layerId,JSON.stringify(serviceData.features)).then(function(result){layerJobs[layerId].attempted+=serviceData.features.length,layerJobs[layerId].added+=result.addResults.length,reportResult(layerId)}).catch(function(){layerJobs[layerId].attempted+=serviceData.features.length,reportResult(layerId)})}).catch(function(){messages.text("Incomplete—check console"),console.info("Errors creating service "+name),console.info("Failed to retrieve all records.")}),offset+=count})})}).catch(function(){clone.find("img").remove(),clone.removeClass("btn-info"),clone.addClass("btn-danger"),messages.text("Failed—check console"),console.info("Errors creating service "+name),console.warn("Failed to create the service.")})})})},makeDroppable=function(id){var portal,destinationPortal=app.portals.destinationPortal,copyItem=function(id,folder){var type=jquery("#"+id).attr("data-type"),portalUrl=jquery("#"+id).attr("data-portal");if(portal="https://www.arcgis.com/"===portalUrl&&portalUrl!==app.portals.sourcePortal.portalUrl?app.portals.arcgisOnline:app.portals.sourcePortal,isSupported(type))portal.itemDescription(id).then(function(description){switch(portal.cacheItem(description),type){case"Feature Service":description.url=portalSelf.util.upgradeUrl(description.url),portal.items[portal.items.length-1].description.url=description.url,portal.serviceDescription(description.url).then(function(serviceDescription){var item=jquery.grep(portal.items,function(item){return item.id===id}),name=description.name;null===name&&(name=description.title),jquery("#serviceName").val(name),item[0].serviceDescription=serviceDescription,jquery("#btnCancelCopy").attr("data-id",description.id),jquery("#btnCopyService").attr("data-id",description.id),jquery("#deepCopyModal").modal("show"),jquery("#btnCopyService").removeClass("disabled"),checkServiceName(destinationPortal)});break;default:simpleCopy(id,folder)}});else{jquery("#"+id).addClass("btn-warning");var html=mustache.to_html(jquery("#contentTypeErrorTemplate").html(),{id:id,type:type});jquery("#"+id).before(html),jquery("#"+id+"_alert").fadeOut(6e3,function(){jquery(this).remove()})}},moveItem=function(item,destination){"use strict";var itemId=jquery(item).attr("data-id"),clone=jquery(item).clone();clone.attr("id",itemId+"_clone"),clone.addClass("clone"),clone.css("max-width",""),clone.insertAfter(destination.children(".dropArea")),clone.removeClass("active btn-primary btn-info");var destinationFolder=clone.parent().attr("data-folder");copyItem(itemId,destinationFolder)};jquery("#dropFolder_"+id).droppable({accept:".content",activeClass:"ui-state-hover",hoverClass:"ui-state-active",drop:function(event,ui){moveItem(ui.draggable,jquery(this).parent().parent())}})},cleanUp=function(){jquery("#dropArea").empty(),jquery(".content").unbind("click"),jquery(".content").removeClass("active btn-primary btn-info ui-draggable")},clearResults=function(){jquery("#itemsArea").empty()},highlightCopyableContent=function(){var setMaxWidth=function(el){var maxWidth=jquery("#itemsArea .in").width()?jquery("#itemsArea .in").width():jquery("#itemsArea").width()?$("#itemsArea").width()-49:400;jquery(el).css("max-width",maxWidth)};jquery("#itemsArea .content").each(function(){var type=jquery(this).attr("data-type");isSupported(type)&&(jquery(this).addClass("btn-info"),setMaxWidth(this),function(el){el.draggable({cancel:!1,helper:"clone",appendTo:"body",revert:!0,opacity:.7}),el.removeAttr("disabled")}(jquery(this)))})},highlightSupportedContent=function(){switch(jquery("#actionDropdown li.active").attr("data-action")){case"startOver":cleanUp();break;case"copyContent":highlightCopyableContent();break;case"updateWebmapServices":cleanUp(),updateWebmapServices();break;case"updateContentUrl":cleanUp(),updateContentUrls();break;case"inspectContent":cleanUp(),inspectContent()}},isSupported=function(type){var supportedTypes=["Web Map","Web Scene","Map Service","Image Service","Scene Service","WMS","Feature Collection","Feature Collection Template","Geodata Service","Globe Service","Geometry Service","Geocoding Service","Network Analysis Service","Geoprocessing Service","Web Mapping Application","Mobile Application","Operation View","Symbol Set","Color Set","Document Link","Feature Service","Vector Tile Service"];if(jquery.inArray(type,supportedTypes)>-1)return!0},sortArrayAlpha=function(array,key){array.sort(function(a,b){var titleA=null,titleB=null;return a[key]&&(titleA=a[key].toUpperCase()),b[key]&&(titleB=b[key].toUpperCase()),titleA<titleB?-1:titleA>titleB?1:0})},listSearchItems=function(portalUrl,results){"use strict";clearResults();var folderData={title:"Search Results ("+results.query+")",id:"search",count:results.total},html=mustache.to_html(jquery("#folderTemplate").html(),folderData);jquery("#itemsArea").append(html),jquery.each(results.results,function(){var templateData={id:this.id,title:this.title,type:this.type,icon:portalSelf.itemInfo(this.type).icon,portal:portalUrl,user:this.owner,idAbbrev:this.id.substring(0,6),idLink:portalUrl+"home/item.html?id="+this.id,agoType:this.type+(this.typeKeywords.indexOf("Hosted Service")>=0?" (Hosted)":"")},html=mustache.to_html(jquery("#contentTemplate").html(),templateData);jquery("#collapse_search").append(html).addClass("in")}),highlightSupportedContent()},listUserItems=function(){"use strict";function storeActivity(activityTime){var seconds=activityTime/1e3;app.stats.activities[seconds]=1}var portal=app.portals.sourcePortal;cleanUp(),clearResults();var portalIdDom=jquery("<h4></h4>"),userIdDom=jquery("<h6></h6>"),refreshBtn=jquery('<a class="pull-right" href="#">Refresh <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>');refreshBtn.on("click",listUserItems),jquery("#itemsArea").append(portalIdDom),jquery("#itemsArea").append(userIdDom),app.portals.sourcePortal.self().then(function(data){var userData=data.user,fullName=(userData.email,userData.fullName),username=userData.username,portalName=data.name||data.portalName;portalName+=' - <a href="'+app.portals.sourcePortal.portalUrl+'" target="_blank">'+app.portals.sourcePortal.portalUrl+"</a>",portalIdDom.html(portalName),userIdDom.text("Current User: "+fullName+" ("+username+")"),userIdDom.append(refreshBtn)}),portal.userContent(portal.username,"/").then(function(content){var folderData={title:"Root",id:"",count:content.items.length},html=mustache.to_html(jquery("#folderTemplate").html(),folderData);jquery("#itemsArea").append(html),sortArrayAlpha(content.items,"title"),jquery.each(content.items,function(item){var templateData={id:this.id,title:this.title,type:this.type,icon:portalSelf.itemInfo(this.type).icon,portal:portal.portalUrl,idAbbrev:this.id.substring(0,6),idLink:portal.portalUrl+"home/item.html?id="+this.id,agoType:this.type+(this.typeKeywords.indexOf("Hosted Service")>=0?" (Hosted)":"")},html=mustache.to_html(jquery("#contentTemplate").html(),templateData);jquery("#collapse_").append(html),storeActivity(content.items[item].modified)}),sortArrayAlpha(content.folders,"title"),jquery.each(content.folders,function(){var folderData={title:this.title,id:this.id,count:0},html=mustache.to_html(jquery("#folderTemplate").html(),folderData);jquery("#itemsArea").append(html),portal.userContent(portal.username,this.id).then(function(content){jquery("#collapse_"+content.currentFolder.id).parent().find("span.badge")[0].innerHTML=content.total,sortArrayAlpha(content.items,"title"),jquery.each(content.items,function(item){var templateData={id:this.id,title:this.title,type:this.type,icon:portalSelf.itemInfo(this.type).icon,portal:portal.portalUrl,idAbbrev:this.id.substring(0,6),idLink:portal.portalUrl+"home/item.html?id="+this.id,agoType:this.type+(this.typeKeywords.indexOf("Hosted Service")>=0?" (Hosted)":"")},html=mustache.to_html(jquery("#contentTemplate").html(),templateData);jquery("#collapse_"+this.ownerFolder).append(html),storeActivity(content.items[item].modified)})})}),setTimeout(function(){highlightSupportedContent()},1e3)})},listUserGroups=function(){"use strict";var portal=app.portals.sourcePortal;cleanUp(),clearResults();var portalIdDom=jquery("<h4></h4>"),userIdDom=jquery("<h6></h6>");jquery("#itemsArea").append(portalIdDom),jquery("#itemsArea").append(userIdDom),portal.self().then(function(data){var userData=data.user,fullName=userData.fullName,username=userData.username,portalName=data.name||data.portalName;portalName+=' - <a href="'+portal.portalUrl+'" target="_blank">'+portal.portalUrl+"</a>",portalIdDom.html(portalName),userIdDom.text("Current User: "+fullName+" ("+username+")"),portal.userProfile(portal.username).then(function(user){sortArrayAlpha(user.groups,"title"),jquery.each(user.groups,function(){var group=this,query="group:"+this.id,folderData={title:this.title,id:this.id,count:0},html=mustache.to_html(jquery("#folderTemplate").html(),folderData);jquery("#itemsArea").append(html),portal.search(query,100,"title","asc").then(function(search){jquery("#collapse_"+group.id).parent().find("span.badge")[0].innerHTML=search.total,jquery.each(search.results,function(){var templateData={id:this.id,title:this.title,type:this.type,icon:portalSelf.itemInfo(this.type).icon,portal:portal.portalUrl,user:this.owner,idAbbrev:this.id.substring(0,6),idLink:portal.portalUrl+"home/item.html?id="+this.id,agoType:this.type+(this.typeKeywords.indexOf("Hosted Service")>=0?" (Hosted)":"")},html=mustache.to_html(jquery("#contentTemplate").html(),templateData);jquery("#collapse_"+group.id).append(html)})})}),setTimeout(function(){highlightSupportedContent()},1e3)})})},showDestinationFolders=function(){"use strict";var portal=app.portals.destinationPortal,portalIdDom=jquery("<h4></h4>"),userIdDom=jquery("<h6></h6>");jquery("#dropArea").append(portalIdDom),jquery("#dropArea").append(userIdDom),app.portals.destinationPortal.self().then(function(data){var userData=data.user,fullName=(userData.email,userData.fullName),username=userData.username,portalName=data.name||data.portalName;portalName+=' - <a href="'+app.portals.destinationPortal.portalUrl+'" target="_blank">'+app.portals.destinationPortal.portalUrl+"</a>",portalIdDom.html(portalName),userIdDom.text("Current User: "+fullName+" ("+username+")")}),portal.userContent(portal.username,"/").then(function(content){var folderData,html;folderData={title:"Root",id:"",count:content.items.length},html=mustache.to_html(jquery("#dropFolderTemplate").html(),folderData),jquery("#dropArea").append(html),sortArrayAlpha(content.items,"title"),jquery.each(content.items,function(){var itemData={id:this.id,title:this.title,type:this.type,icon:portalSelf.itemInfo(this.type).icon,portal:portal.portalUrl,idAbbrev:this.id.substring(0,6),idLink:portal.portalUrl+"home/item.html?id="+this.id,agoType:this.type+(this.typeKeywords.indexOf("Hosted Service")>=0?" (Hosted)":"")},html=mustache.to_html(jquery("#contentTemplate").html(),itemData);jquery("#collapseDest_").append(html)}),makeDroppable(""),sortArrayAlpha(content.folders,"title"),jquery.each(content.folders,function(){folderData={title:this.title,id:this.id,count:0},html=mustache.to_html(jquery("#dropFolderTemplate").html(),folderData),jquery("#dropArea").append(html),portal.userContent(portal.username,this.id).then(function(content){sortArrayAlpha(content.items,"title"),jquery.each(content.items,function(){var templateData={id:this.id,title:this.title,type:this.type,icon:portalSelf.itemInfo(this.type).icon,portal:portal.portalUrl,idAbbrev:this.id.substring(0,6),idLink:portal.portalUrl+"home/item.html?id="+this.id,agoType:this.type+(this.typeKeywords.indexOf("Hosted Service")>=0?" (Hosted)":"")},html=mustache.to_html(jquery("#contentTemplate").html(),templateData);jquery("#collapseDest_"+content.currentFolder.id).append(html)}),jquery("#collapseDest_"+content.currentFolder.id).collapse("hide"),makeDroppable(content.currentFolder.id)})})})};jquery(document).ready(function(){jquery(".loginButtons > p > button").removeAttr("disabled"),sessionStorage.esriJSAPIOAuthBackup&&sessionStorage.esriIdBackup&&(esriId.destroyCredentials(),esriId.initialize(JSON.parse(sessionStorage.getItem("esriIdBackup"))),sessionStorage.setItem("esriJSAPIOAuth",sessionStorage.getItem("esriJSAPIOAuthBackup"))),esriId.registerOAuthInfos([appInfo]),portalSelf.util.fixUrl(appInfo.portalUrl).then(function(portalUrl){var sharingUrl=portalUrl;-1===sharingUrl.indexOf("arcgis.com")&&(sharingUrl+="sharing/"),esriId.checkSignInStatus(sharingUrl).then(function(user){jquery("#splashContainer").css("display","none"),jquery("#itemsContainer").css("display","block"),app.portals.sourcePortal=new portalSelf.Portal({portalUrl:portalUrl,username:user.userId,token:user.token}),startSession()}).otherwise(function(){jquery("#itemsContainer").css("display","none"),jquery("#splashContainer").css("display","block");var portal=getUrlParameter("portal"),appid=getUrlParameter("appid");portal&&(app.portals.sourcePortal=new portalSelf.Portal({portalUrl:portal}),jquery("#portalUrl").val(portal),validateUrl("#portalUrl",app.portals.sourcePortal,"#portalLoginBtn"),jquery("[data-action='login-portal']").trigger("click"),appid&&(jquery("#portalAppId").val(appid),jquery("#oauthTabBtn").trigger("click")))})});var resizeContentAreas=function(){"use strict";jquery(".itemArea").height(jquery(window).height()-60)};resizeContentAreas();!function(){"use strict";jquery("html").bind("keypress",function(e){if(13===e.keyCode&&"true"!==jquery(e.target).attr("contenteditable")&&0===jquery(e.target).parents(".jsonViewer").length)return!1})}(),jquery("#portalDestinationGroup").css({display:"none"}),jquery("#destinationAgolBtn").click(function(){jquery(".alert-danger.alert-dismissable").remove(),jquery("#destinationUrl").next().removeClass("glyphicon-ok"),jquery("#destinationUrl").parent().removeClass("has-error"),jquery("#destinationUrl").attr({placeholder:"",value:"https://www.arcgis.com/"}),jquery("#destinationUrl").val("https://www.arcgis.com/"),jquery("#portalDestinationGroup").css({display:"none"}),jquery("#destinationLoginBtn").css({display:"none"}),jquery("#destinationEnterpriseBtn").css({display:"inline"}),jquery("#destinationAgolBtn").addClass("btn-primary active"),jquery("#destinationPortalBtn").removeClass("btn-primary active"),app.portals.destinationPortal&&(app.portals.destinationPortal.portalUrl="https://www.arcgis.com/")}),jquery("#destinationPortalBtn").click(function(){jquery("#destinationUrl").attr({placeholder:"https://myportal.domain.com/",value:""}),jquery("#portalAppId2").val(""),jquery("#destinationUrl").val(""),jquery("#portalDestinationGroup").css({display:"block"}),jquery("#destinationLoginBtn").css({display:"inline"}),jquery("#destinationEnterpriseBtn").css({display:"none"}),jquery("#destinationPortalBtn").addClass("btn-primary active"),jquery("#destinationAgolBtn").removeClass("btn-primary active"),jquery("#userPassTab2Btn").trigger("click")}),jquery(window).resize(function(){resizeContentAreas()}),jquery("#portalUrl").blur(function(){app.portals.sourcePortal||(app.portals.sourcePortal=new portalSelf.Portal),setTimeout(function(){validateUrl("#portalUrl",app.portals.sourcePortal,"#portalLoginBtn")},500)}),jquery("#destinationUrl").blur(function(){app.portals.destinationPortal||(app.portals.destinationPortal=new portalSelf.Portal),setTimeout(function(){jquery("#destinationPortalBtn").hasClass("active")&&validateUrl("#destinationUrl",app.portals.destinationPortal,"#destinationLoginBtn")},500)}),jquery("[data-action='login-agol']").click(function(){esriId.getCredential(appInfo.portalUrl,{oAuthPopupConfirmation:!1}).then(function(user){jquery("#splashContainer").css("display","none"),jquery("#itemsContainer").css("display","block"),app.portals.sourcePortal=new portalSelf.Portal({portalUrl:user.server+"/",username:user.userId,token:user.token}),startSession()})}),jquery("[data-action='logindestination']").click(function(){var appIdJson=esriId.toJson(),esriJSAPIOAuth=sessionStorage.esriJSAPIOAuth;sessionStorage.setItem("esriJSAPIOAuthBackup",esriJSAPIOAuth),sessionStorage.setItem("esriIdBackup",JSON.stringify(appIdJson)),esriId.destroyCredentials(),sessionStorage.removeItem("esriJSAPIOAuth"),esriId.getCredential(appInfo.portalUrl,{oAuthPopupConfirmation:!1}).then(function(user){app.portals.destinationPortal&&app.portals.destinationPortal.portalUrl===appInfo.portalUrl||(app.portals.destinationPortal=new portalSelf.Portal({portalUrl:user.server+"/",username:user.userId,token:user.token})),esriId.initialize(appIdJson),sessionStorage.setItem("esriJSAPIOAuth",esriJSAPIOAuth),app.portals.destinationPortal.self().then(function(){jquery("#copyModal").modal("hide"),highlightCopyableContent(),NProgress.start(),showDestinationFolders(),NProgress.done()})})}),jquery("#portalLoginBtn").click(function(){loginPortal()}),jquery("[data-action='copyMyAccount']").click(function(){app.portals.destinationPortal=app.portals.sourcePortal,jquery("#copyModal").modal("hide"),highlightCopyableContent(),NProgress.start(),showDestinationFolders(),NProgress.done()}),jquery("[data-action='copyOtherAccount']").click(function(){jquery("#destinationChoice").css("display","none"),jquery("#destinationForm").css("display","block")}),jquery("#destinationLoginBtn").click(function(){loginDestination()}),jquery("#destinationLoginBtn").click(function(){jquery("#destinationLoginBtn").button("reset")}),jquery("#destinationCancelBtn").click(function(){jquery("#actionDropdown li").removeClass("active")}),jquery("#destinationLoginForm").keypress(function(e){13==e.which&&jquery("#destinationLoginBtn").focus().click()}),jquery("#portalLoginForm").keypress(function(e){13==e.which&&jquery("#portalLoginBtn").focus().click()}),jquery(document).on("click","#searchMenu li",function(e){var selectedAction=jquery(e.target).parent().attr("data-action");"viewMyContent"!==selectedAction&&"viewMyGroups"!==selectedAction?(jquery("#searchMenu li").removeClass("active"),jquery(e.target).parent().addClass("active"),jquery("#searchText").val()?search():jquery("#searchText").attr("placeholder",jquery(e.currentTarget).text())):"viewMyGroups"==selectedAction?(NProgress.start(),jquery("#actionDropdown li").removeClass("active"),listUserGroups(),NProgress.done()):(NProgress.start(),jquery("#actionDropdown li").removeClass("active"),listUserItems(),NProgress.done())}),jquery(document).on("click","#btnSimpleCopy",function(){jquery("#serviceNameForm").hide(),jquery(".alert-danger.alert-dismissable").remove(),jquery("#btnCopyService").removeClass("disabled"),jquery("#btnSimpleCopy").addClass("btn-primary active"),jquery("#btnFullCopy").removeClass("btn-primary active"),jquery("#btnFullCopy").addClass("btn-default")}),jquery(document).on("click","#btnFullCopy",function(){jquery("#serviceNameForm").show(),jquery("#btnCopyService").addClass("disabled"),jquery("#btnFullCopy").addClass("btn-primary active"),jquery("#btnSimpleCopy").removeClass("btn-primary active"),jquery("#btnSimpleCopy").addClass("btn-default"),jquery("#serviceName").blur()}),jquery(document).on("click","#btnCancelCopy",function(e){var id=jquery(e.currentTarget).attr("data-id");jquery(".clone[data-id='"+id+"']").remove(),jquery("#btnCancelCopy").attr("data-id",""),jquery("#serviceName").attr("value",""),jquery("#btnSimpleCopy").click(),jquery("#deepCopyModal").modal("hide")}),jquery(document).on("click","#btnCopyService",function(e){var id=jquery(e.currentTarget).attr("data-id"),folder=jquery(".clone[data-id='"+id+"']").parent().attr("data-folder");switch(jquery("#copySelector > .btn-primary").text()){case"Simple":simpleCopy(id,folder);break;case"Full":deepCopyFeatureService(id,folder)}jquery("#btnCancelCopy").attr("data-id",""),jquery("#serviceName").attr("value",""),jquery("#btnSimpleCopy").click(),jquery("#deepCopyModal").modal("hide")}),jquery(document).on("click","li [data-action]",function(e){var selectedAction=jquery(e.target).parent().attr("data-action");switch("stats"!==selectedAction&&(jquery("#actionDropdown li").removeClass("active"),jquery(e.target).parent().addClass("active")),selectedAction){case"startOver":cleanUp(),jquery("#searchText").val(""),listUserItems();break;case"inspectContent":cleanUp(),inspectContent();break;case"updateWebmapServices":cleanUp(),updateWebmapServices();break;case"updateContentUrl":cleanUp(),updateContentUrls();break;case"stats":viewStats();break;case"logout":logout()}}),jquery("#copyModal").on("show.bs.modal",function(){cleanUp(),jquery("#destinationChoice").css("display","block"),jquery("#destinationForm").css("display","none")}),jquery("#currentUrl").text(window.location.origin+window.location.pathname),jquery("#currentUrl2").text(window.location.origin+window.location.pathname)})});